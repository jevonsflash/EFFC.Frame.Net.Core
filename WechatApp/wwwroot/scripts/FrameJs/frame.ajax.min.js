(function($,fns){fns.Ajax={Ajax:function(options){var dtd=$.Deferred();var defaults={url:"",returntype:"json",postdata:"",before:null,success:null,complete:null,fail:null,async:true,xhr:null,contenttype:"application/x-www-form-urlencoded",processdata:true,crossDomain:true,preprocessresult:true};var opts=$.extend(defaults,options);if(fns.Config.Ajax){if(fns.Config.Ajax.beforeAjax){fns.Config.Ajax.beforeAjax(opts)}}var datatype=opts.returntype=="json"?"text":opts.returntype;if(opts.url!=""){var p={type:"Post",url:opts.url,dataType:datatype,cache:false,data:opts.postdata,async:opts.async,processData:opts.processdata,contentType:opts.contenttype,beforeSend:function(e){if(opts.before!=null){opts.before(e)}},success:function(rtn){var jobj;if(opts.preprocessresult){if(rtn!=null){if(jobj==null){jobj=rtn}if(opts.returntype.toLowerCase()=="json"){var bobj=eval("("+jobj+")");if(bobj.ErrorCode==""){if(opts.success!=null){opts.success(bobj.Content)}else{dtd.resolve(bobj.Content)}}else{fns.ExceptionProcess.ShowErrorMsg(bobj.ErrorCode+"\n"+bobj.ErrorMessage);if(opts.fail){opts.fail(bobj.ErrorCode,bobj.ErrorMessage)}else{dtd.reject(bobj.ErrorCode,bobj.ErrorMessage)}}}else{if(opts.success!=null){opts.success(jobj)}else{dtd.resolve(jobj)}}}}else{if(opts.success!=null){opts.success(jobj)}else{dtd.resolve(jobj)}}},complete:function(e,o){completehandler(e,o,opts)},error:function(e,o,r){errorhandler(e,o,r,opts);dtd.reject(o)}};if(opts.xhr!=null){p.xhr=function(){if(opts.xhr!=null){return opts.xhr()}else{return new XMLHttpRequest}}}$.ajax(p)}else{fns.ExceptionProcess.ShowErrorMsg("需要提供url信息！")}return dtd.promise()},AjaxForm:function(e){var o=$.Deferred();var r={url:"",formid:"",returntype:"html",before:null,success:null,complete:null,fail:null};var s=$.extend(r,e);if(s.formid==""){fns.ExceptionProcess.ShowErrorMsg("需要提供formid信息！");return false}if(s.url==""){fns.ExceptionProcess.ShowErrorMsg("需要提供url信息！");return false}var t=$("#"+s.formid);t.unbind();var n=s.returntype==""?"html":s.returntype;var l={url:s.url,type:"post",cache:false,datatype:n,beforeSubmit:function(e,o){if(s.befersend!=null){s.befersend(e,o)}},success:function(e){if(s.returntype.toLowerCase()=="json"){if(e!=null){var r=$.parseJSON(e);if(r==null){r=e}if(r.ErrorCode==""){if(r.Content.__isneedlogin__){fns.Message.DialogLogin("请先登录！",r.Content.__loginurl__)}else{if(s.success!=null){s.success(r.Content)}else{o.resolve(bobj.Content)}}}else{fns.ExceptionProcess.ShowErrorMsg(r.ErrorCode+"\n"+r.ErrorMessage);if(s.fail){s.fail(r.ErrorCode,r.ErrorMessage)}else{o.reject(bobj.ErrorCode,bobj.ErrorMessage)}}}}else{if(s.success!=null){s.success(e)}else{o.resolve(e)}}},complete:function(e,o){completehandler(e,o,s)},error:function(e,r,t){errorhandler(e,r,t,s);o.reject(r)}};t.submit(function(){$(this).ajaxSubmit(l);return false});t.submit();return o.promise()},AjaxUpload:function(e){var o={url:"",returntype:"json",postdata:"",before:null,success:null,complete:null,fail:null,xhr:null};var r=$.extend(o,e);var s=new FormData;if(r.postdata!=null){for(var t in r.postdata){s.append(t,r.postdata[t])}}r.processdata=false;r.contenttype=false;r.postdata=s;return this.Ajax(r)}};function successhandler(rtn,opts){var jobj;if(opts.preprocessresult){if(rtn!=null){if(jobj==null){jobj=rtn}if(opts.returntype.toLowerCase()=="json"){var bobj=eval("("+jobj+")");if(bobj.ErrorCode==""){if(typeof bobj.Content.__isvalid__!="undefined"&&!bobj.Content.__isvalid__){fns.Message.DialogToUrl(bobj.Content.__msg__,bobj.Content.__tonurl__)}else{if(opts.success!=null){opts.success(bobj.Content)}}}else{fns.ExceptionProcess.ShowErrorMsg(bobj.ErrorCode+"\n"+bobj.ErrorMessage);if(opts.fail){opts.fail(bobj.ErrorCode,bobj.ErrorMessage)}}}else{if(opts.success!=null){opts.success(jobj)}}}}else{if(opts.success!=null){opts.success(jobj)}}}function completehandler(e,o,r){if(r.complete!=null){r.complete(e,o)}}function errorhandler(e,o,r,s){if(s.fail){s.fail(o,o)}}})(jQuery,FrameNameSpace);